name: Code Quality & Security
# 1. å®æ—¶è§¦å‘ (ä¸ä¸»å·¥ä½œæµå¹¶è¡Œ)
#    - Push åˆ° main/develop
#    - PR åˆ›å»º/æ›´æ–°

# 2. å®šæ—¶æ‰§è¡Œ (ç‹¬ç«‹è¿è¡Œ)
#    - æ¯æ—¥ UTC 02:00
#    - æ·±åº¦å®‰å…¨æ‰«æ
#    - ä¾èµ–æ¼æ´æ£€æŸ¥

# 3. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#    - å¯é€šè¿‡ GitHub UI æ‰‹åŠ¨æ‰§è¡Œ

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å¤© UTC 2:00 è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 2 * * *'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºåˆ†æ
          
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'agent-backend/requirements.txt'
      
      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: npm ci
        
      - name: å®‰è£…åç«¯ä¾èµ–
        run: |
          cd agent-backend
          pip install -r requirements.txt
          pip install bandit safety semgrep
      
      # å‰ç«¯ä»£ç è´¨é‡
      - name: ESLint æ£€æŸ¥
        run: |
          npm run lint -- --format json --output-file eslint-report.json || true
          
      - name: TypeScript ç¼–è¯‘æ£€æŸ¥
        run: |
          npx tsc --noEmit --skipLibCheck
          
      - name: Prettier æ ¼å¼æ£€æŸ¥
        run: |
          npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}"
      
      # åç«¯ä»£ç è´¨é‡
      - name: Python ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          cd agent-backend
          black --check --diff .
          
      - name: Python ä»£ç è§„èŒƒæ£€æŸ¥
        run: |
          cd agent-backend
          flake8 . --format=json --output-file=../flake8-report.json || true
          
      - name: Python ç±»å‹æ£€æŸ¥
        run: |
          cd agent-backend
          mypy . --strict || true
      
      # ä»£ç å¤æ‚åº¦åˆ†æ
      - name: å‰ç«¯å¤æ‚åº¦åˆ†æ
        run: |
          npx eslint app/ lib/ --ext .ts,.tsx -f json -o complexity-report.json || true
        continue-on-error: true
        
      # ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
      - name: ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            eslint-report.json
            flake8-report.json
            complexity-report.json
          retention-days: 30

  # å®‰å…¨æ¼æ´æ‰«æ
  security-scan:
    name: å®‰å…¨æ¼æ´æ‰«æ
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      actions: read
      contents: read
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'agent-backend/requirements.txt'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          cd agent-backend
          pip install -r requirements.txt
          pip install bandit safety pip-audit semgrep
      
      # å‰ç«¯ä¾èµ–æ¼æ´æ‰«æ
      - name: NPM å®‰å…¨å®¡è®¡
        run: |
          npm audit --audit-level=moderate --json > npm-audit.json || true
          
      # åç«¯ä¾èµ–æ¼æ´æ‰«æ
      - name: Python ä¾èµ–å®‰å…¨æ£€æŸ¥
        run: |
          cd agent-backend
          safety check --json --output ../safety-report.json || true
          pip-audit --format=json --output=../pip-audit.json || true
      
      # ä»£ç å®‰å…¨æ‰«æ
      - name: Bandit å®‰å…¨æ‰«æ
        run: |
          cd agent-backend
          bandit -r . -f json -o ../bandit-report.json || true
          
      # Semgrep å®‰å…¨æ‰«æ
      - name: Semgrep æ‰«æ
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
        continue-on-error: true
        
      # CodeQL åˆ†æ
      - name: åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, python
          queries: security-and-quality
          
      - name: è‡ªåŠ¨æ„å»º
        uses: github/codeql-action/autobuild@v2
        
      - name: æ‰§è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:javascript,python"
      
      # å¯†é’¥æ³„éœ²æ£€æŸ¥
      - name: æ£€æŸ¥å¯†é’¥æ³„éœ²
        run: |
          # ä½¿ç”¨ gitleaks æ£€æŸ¥å¯†é’¥æ³„éœ²
          docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest detect \
            --source /repo \
            --report-format json \
            --report-path /repo/gitleaks-report.json || true
        continue-on-error: true
      
      # ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            npm-audit.json
            safety-report.json
            pip-audit.json
            bandit-report.json
            gitleaks-report.json
          retention-days: 90

  # è®¸å¯è¯åˆè§„æ£€æŸ¥
  license-check:
    name: è®¸å¯è¯åˆè§„æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: è®¸å¯è¯æ£€æŸ¥
        run: |
          npx license-checker --json --out license-report.json
          npx license-checker --summary
        continue-on-error: true
        
      - name: ä¸Šä¼ è®¸å¯è¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

  # æ€§èƒ½åŸºçº¿æµ‹è¯•
  performance-baseline:
    name: æ€§èƒ½åŸºçº¿æµ‹è¯•
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm install -g lighthouse-ci
          
      - name: æ„å»ºåº”ç”¨
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          
      - name: å¯åŠ¨åº”ç”¨
        run: |
          npm start &
          sleep 10
        
      - name: Lighthouse CI
        run: |
          lhci autorun --config=.lighthouserc.json || true
        continue-on-error: true

  # æ±‡æ€»æŠ¥å‘Š
  quality-summary:
    name: è´¨é‡æ±‡æ€»æŠ¥å‘Š
    needs: [code-quality, security-scan, license-check]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
        uses: actions/download-artifact@v3
        
      - name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        run: |
          echo "# ä»£ç è´¨é‡ä¸å®‰å…¨æ‰«ææŠ¥å‘Š" > quality-summary.md
          echo "" >> quality-summary.md
          echo "**æ‰«ææ—¶é—´**: $(date)" >> quality-summary.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> quality-summary.md
          echo "**æäº¤**: ${{ github.sha }}" >> quality-summary.md
          echo "" >> quality-summary.md
          
          echo "## æ‰«æç»“æœ" >> quality-summary.md
          echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}" >> quality-summary.md
          echo "- å®‰å…¨æ¼æ´æ‰«æ: ${{ needs.security-scan.result }}" >> quality-summary.md
          echo "- è®¸å¯è¯åˆè§„: ${{ needs.license-check.result }}" >> quality-summary.md
          echo "" >> quality-summary.md
          
          # å¦‚æœæœ‰æŠ¥å‘Šæ–‡ä»¶ï¼Œæ·»åŠ è¯¦ç»†ä¿¡æ¯
          if [ -f "code-quality-reports/eslint-report.json" ]; then
            echo "## ESLint æ£€æŸ¥ç»“æœ" >> quality-summary.md
            # è§£æå¹¶æ ¼å¼åŒ– eslint æŠ¥å‘Š
          fi
          
          if [ -f "security-reports/npm-audit.json" ]; then
            echo "## NPM å®‰å…¨å®¡è®¡ç»“æœ" >> quality-summary.md
            # è§£æå¹¶æ ¼å¼åŒ– npm audit æŠ¥å‘Š
          fi
          
      - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary
          path: quality-summary.md
          retention-days: 90
          
      - name: PR è¯„è®º
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let summary = '# ğŸ” ä»£ç è´¨é‡ä¸å®‰å…¨æ‰«æç»“æœ\n\n';
            
            // æ·»åŠ æ‰«æç»“æœ
            summary += `| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ |\n`;
            summary += `|---------|------|\n`;
            summary += `| ä»£ç è´¨é‡æ£€æŸ¥ | ${{ needs.code-quality.result == 'success' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥' }} |\n`;
            summary += `| å®‰å…¨æ¼æ´æ‰«æ | ${{ needs.security-scan.result == 'success' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥' }} |\n`;
            summary += `| è®¸å¯è¯åˆè§„ | ${{ needs.license-check.result == 'success' ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥' }} |\n`;
            
            summary += '\nğŸ“Š è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ [Actions é¡µé¢](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
