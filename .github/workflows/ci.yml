name: CI Pipeline

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯å¤© UTC 2:00 è¿è¡Œæ·±åº¦å®‰å…¨æ‰«æ
    - cron: '0 2 * * *'
  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # å‰ç«¯è´¨é‡æ£€æŸ¥
  frontend-ci:
    name: å‰ç«¯CIæ£€æŸ¥
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm run preflight
      
      # ä»£ç è´¨é‡æ£€æŸ¥
      - name: ESLint æ£€æŸ¥
        run: npm run lint -- --max-warnings 100
        
      - name: TypeScript ç±»åž‹æ£€æŸ¥
        run: npx tsc --noEmit
      
      # æµ‹è¯•å¥—ä»¶
      - name: è¿è¡Œæµ‹è¯•
        run: |
          npm run test:ci
          npm run test:coverage
      
      - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: frontend
          name: frontend-coverage-${{ matrix.node-version }}
          fail_ci_if_error: false
      
      # æž„å»ºéªŒè¯
      - name: æž„å»ºéªŒè¯
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_OPTIONS: '--max-old-space-size=4096'
      
      # ç¼“å­˜æž„å»ºäº§ç‰© (ä¸ºCDå‡†å¤‡)
      - name: ç¼“å­˜æž„å»ºäº§ç‰©
        uses: actions/cache@v3
        if: matrix.node-version == '20' && github.ref == 'refs/heads/main'
        with:
          path: .next
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ github.sha }}

  # åŽç«¯è´¨é‡æ£€æŸ¥
  backend-ci:
    name: åŽç«¯CIæ£€æŸ¥
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    defaults:
      run:
        working-directory: ./agent-backend
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'agent-backend/requirements.txt'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio black flake8 mypy
      
      # ä»£ç è´¨é‡æ£€æŸ¥
      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        run: |
          black --check --diff .
          flake8 .
      
      - name: ç±»åž‹æ£€æŸ¥
        run: mypy . || true
      
      # æµ‹è¯•å¥—ä»¶
      - name: è¿è¡Œæµ‹è¯•
        run: pytest --cov=app --cov-report=xml --cov-report=html --cov-report=term
      
      - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        with:
          file: ./agent-backend/coverage.xml
          flags: backend
          name: backend-coverage-${{ matrix.python-version }}
          fail_ci_if_error: false
      
      # Dockeræž„å»ºéªŒè¯
      - name: Dockeræž„å»ºéªŒè¯
        if: matrix.python-version == '3.11'
        run: |
          echo "ðŸ³ éªŒè¯Dockeræž„å»º..."
          docker build -t doudou-backend:ci-test .
          echo "âœ… Dockeræž„å»ºéªŒè¯é€šè¿‡"

  # å¢žå¼ºå®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨ä¸Žè´¨é‡æ‰«æ
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽæ·±åº¦åˆ†æž
        
      - name: è®¾ç½®çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'agent-backend/requirements.txt'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          cd agent-backend
          pip install -r requirements.txt
          pip install safety pip-audit bandit semgrep
      
      # å‰ç«¯å®‰å…¨æ£€æŸ¥
      - name: NPM å®‰å…¨å®¡è®¡
        run: |
          npm audit --audit-level=moderate --json > npm-audit.json || true
          
      # åŽç«¯å®‰å…¨æ£€æŸ¥  
      - name: Python ä¾èµ–å®‰å…¨æ£€æŸ¥
        run: |
          cd agent-backend
          safety check --json --output ../safety-report.json || true
          pip-audit --format=json --output=../pip-audit.json || true
          
      - name: Bandit å®‰å…¨æ‰«æ
        run: |
          cd agent-backend
          bandit -r . -f json -o ../bandit-report.json || true
          
      # é«˜çº§å®‰å…¨æ‰«æ
      - name: Semgrep æ‰«æ
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
        continue-on-error: true
        
      # å¯†é’¥æ³„éœ²æ£€æŸ¥
      - name: æ£€æŸ¥å¯†é’¥æ³„éœ²
        run: |
          docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest detect \
            --source /repo \
            --report-format json \
            --report-path /repo/gitleaks-report.json || true
        continue-on-error: true
        
      # CodeQL åˆ†æž
      - name: åˆå§‹åŒ– CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, python
          queries: security-and-quality
          
      - name: è‡ªåŠ¨æž„å»º
        uses: github/codeql-action/autobuild@v2
        
      - name: æ‰§è¡Œ CodeQL åˆ†æž
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:javascript,python"
      
      # ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            npm-audit.json
            safety-report.json
            pip-audit.json
            bandit-report.json
            gitleaks-report.json
          retention-days: 90

  # è®¸å¯è¯åˆè§„æ£€æŸ¥
  license-check:
    name: è®¸å¯è¯åˆè§„æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: è®¸å¯è¯æ£€æŸ¥
        run: |
          npx license-checker --json --out license-report.json
          npx license-checker --summary
        continue-on-error: true
        
      - name: ä¸Šä¼ è®¸å¯è¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

  # æ€§èƒ½åŸºçº¿æµ‹è¯•
  performance-test:
    name: æ€§èƒ½åŸºçº¿æµ‹è¯•
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm install -g lighthouse-ci
          
      - name: æž„å»ºåº”ç”¨
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          
      - name: å¯åŠ¨åº”ç”¨
        run: |
          npm start &
          sleep 10
        
      - name: Lighthouse CI
        run: |
          lhci autorun --config=.lighthouserc.json || true
        continue-on-error: true
        
      - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report
          path: .lighthouseci/
          retention-days: 30

  # CIçŠ¶æ€æ±‡æ€»å’ŒæŠ¥å‘Š
  ci-status:
    name: CIçŠ¶æ€æ£€æŸ¥ä¸ŽæŠ¥å‘Šæ±‡æ€»
    needs: [frontend-ci, backend-ci, security-scan, license-check, performance-test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š
        uses: actions/download-artifact@v5
        continue-on-error: true
        
      - name: æ£€æŸ¥CIçŠ¶æ€
        id: ci-check
        run: |
          echo "ðŸ” æ£€æŸ¥å„é¡¹CIç»“æžœ..."
          echo "å‰ç«¯CI: ${{ needs.frontend-ci.result }}"
          echo "åŽç«¯CI: ${{ needs.backend-ci.result }}"
          echo "å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}"
          echo "è®¸å¯è¯æ£€æŸ¥: ${{ needs.license-check.result }}"
          echo "æ€§èƒ½æµ‹è¯•: ${{ needs.performance-test.result }}"
          
          # æ£€æŸ¥æ ¸å¿ƒCIæ˜¯å¦é€šè¿‡
          if [[ "${{ needs.frontend-ci.result }}" == "failure" || "${{ needs.backend-ci.result }}" == "failure" ]]; then
            echo "âŒ æ ¸å¿ƒCIæ£€æŸ¥å¤±è´¥"
            echo "ci-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "âœ… æ ¸å¿ƒCIæ£€æŸ¥é€šè¿‡"
          echo "ci-passed=true" >> $GITHUB_OUTPUT
      
      - name: ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        run: |
          echo "# ðŸ” CI/CD æ±‡æ€»æŠ¥å‘Š" > ci-summary.md
          echo "" >> ci-summary.md
          echo "**æž„å»ºæ—¶é—´**: $(date)" >> ci-summary.md
          echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> ci-summary.md
          echo "**æäº¤**: ${{ github.sha }}" >> ci-summary.md
          echo "**è§¦å‘äº‹ä»¶**: ${{ github.event_name }}" >> ci-summary.md
          echo "" >> ci-summary.md
          
          echo "## ðŸ“Š æ£€æŸ¥ç»“æžœ" >> ci-summary.md
          echo "| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | è¯´æ˜Ž |" >> ci-summary.md
          echo "|---------|------|------|" >> ci-summary.md
          
          # å‰ç«¯CI
          if [[ "${{ needs.frontend-ci.result }}" == "success" ]]; then
            echo "| ðŸŒ å‰ç«¯CI | âœ… é€šè¿‡ | ESLint, TypeScript, æµ‹è¯• |" >> ci-summary.md
          else
            echo "| ðŸŒ å‰ç«¯CI | âŒ å¤±è´¥ | æ£€æŸ¥ä»£ç è§„èŒƒå’Œæµ‹è¯• |" >> ci-summary.md
          fi
          
          # åŽç«¯CI  
          if [[ "${{ needs.backend-ci.result }}" == "success" ]]; then
            echo "| ðŸ åŽç«¯CI | âœ… é€šè¿‡ | Black, Flake8, PyTest |" >> ci-summary.md
          else
            echo "| ðŸ åŽç«¯CI | âŒ å¤±è´¥ | æ£€æŸ¥ä»£ç æ ¼å¼å’Œæµ‹è¯• |" >> ci-summary.md
          fi
          
          # å®‰å…¨æ‰«æ
          if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "| ðŸ”’ å®‰å…¨æ‰«æ | âœ… é€šè¿‡ | ä¾èµ–å®¡è®¡, CodeQL, å¯†é’¥æ£€æŸ¥ |" >> ci-summary.md
          else
            echo "| ðŸ”’ å®‰å…¨æ‰«æ | âš ï¸ è­¦å‘Š | å‘çŽ°æ½œåœ¨å®‰å…¨é—®é¢˜ |" >> ci-summary.md
          fi
          
          # è®¸å¯è¯æ£€æŸ¥
          if [[ "${{ needs.license-check.result }}" == "success" ]]; then
            echo "| ðŸ“œ è®¸å¯è¯æ£€æŸ¥ | âœ… é€šè¿‡ | ä¾èµ–è®¸å¯è¯åˆè§„ |" >> ci-summary.md
          else
            echo "| ðŸ“œ è®¸å¯è¯æ£€æŸ¥ | âš ï¸ è­¦å‘Š | æ£€æŸ¥ä¾èµ–è®¸å¯è¯ |" >> ci-summary.md
          fi
          
          # æ€§èƒ½æµ‹è¯•
          if [[ "${{ needs.performance-test.result }}" == "success" ]]; then
            echo "| ðŸš€ æ€§èƒ½æµ‹è¯• | âœ… é€šè¿‡ | Lighthouse åŸºå‡†æµ‹è¯• |" >> ci-summary.md
          elif [[ "${{ needs.performance-test.result }}" == "skipped" ]]; then
            echo "| ðŸš€ æ€§èƒ½æµ‹è¯• | â­ï¸ è·³è¿‡ | ä»…PRå’Œå®šæ—¶ä»»åŠ¡è¿è¡Œ |" >> ci-summary.md
          else
            echo "| ðŸš€ æ€§èƒ½æµ‹è¯• | âš ï¸ è­¦å‘Š | æ€§èƒ½åŸºå‡†æœªè¾¾æ ‡ |" >> ci-summary.md
          fi
          
          echo "" >> ci-summary.md
          echo "## ðŸ“ˆ è¯¦ç»†æŠ¥å‘Š" >> ci-summary.md
          echo "è¯¦ç»†çš„æ£€æŸ¥æŠ¥å‘Šå’Œæ—¥å¿—å¯åœ¨ [Actions é¡µé¢](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) æŸ¥çœ‹ã€‚" >> ci-summary.md
      
      - name: ä¸Šä¼ æ±‡æ€»æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary-report
          path: ci-summary.md
          retention-days: 90
          
      - name: PR è¯„è®º
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            try {
              const summary = fs.readFileSync('ci-summary.md', 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
              
              console.log('âœ… PRè¯„è®ºå‘å¸ƒæˆåŠŸ');
            } catch (error) {
              console.log('âš ï¸ PRè¯„è®ºå‘å¸ƒå¤±è´¥:', error.message);
            }
      
      - name: è®¾ç½®æœ€ç»ˆçŠ¶æ€
        run: |
          echo "CI_PASSED=${{ steps.ci-check.outputs.ci-passed }}" >> $GITHUB_ENV
          echo "BUILD_SHA=${{ github.sha }}" >> $GITHUB_ENV
          echo "REPORT_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
