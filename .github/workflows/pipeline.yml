name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘ç”¨äºæµ‹è¯•
  workflow_dispatch:
    inputs:
      ci_passed:
        description: 'CIæ˜¯å¦é€šè¿‡'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

# æ˜ç¡®çš„æƒé™é…ç½®
permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # è¿è¡ŒCIæµ‹è¯•
  run-ci:
    name: è¿è¡ŒCIæµ‹è¯•
    runs-on: ubuntu-latest
    outputs:
      ci-passed: ${{ steps.ci-result.outputs.ci-passed }}
      branch: ${{ steps.ci-result.outputs.branch }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm run preflight
      
      - name: è¿è¡ŒCIæµ‹è¯•
        run: |
          npm run lint
          npm run test:ci
          npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_OPTIONS: '--max-old-space-size=4096'
          
      - name: è®¾ç½®CIç»“æœ
        id: ci-result
        run: |
          echo "âœ… CIæµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡éƒ¨ç½²"
          echo "ci-passed=true" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² (mainåˆ†æ”¯ï¼ŒCIé€šè¿‡å)
  deploy-production:
    name: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
    needs: [run-ci]
    if: needs.run-ci.outputs.ci-passed == 'true' && needs.run-ci.outputs.branch == 'main'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” è°ƒè¯•Secretsè®¿é—®æƒ…å†µ
        run: |
          echo "=== åŸºæœ¬ç¯å¢ƒä¿¡æ¯ ==="
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "ä»“åº“: ${{ github.repository }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "=== Secretsè®¿é—®æµ‹è¯• ==="
          echo "VERCEL_TOKEN å­˜åœ¨: ${{ secrets.VERCEL_TOKEN != '' }}"
          echo "VERCEL_ORG_ID å­˜åœ¨: ${{ secrets.VERCEL_ORG_ID != '' }}"
          echo "VERCEL_PROJECT_ID å­˜åœ¨: ${{ secrets.VERCEL_PROJECT_ID != '' }}"
          echo "VERCEL_BACKEND_PROJECT_ID å­˜åœ¨: ${{ secrets.VERCEL_BACKEND_PROJECT_ID != '' }}"
          echo "GITHUB_TOKEN å­˜åœ¨: ${{ secrets.GITHUB_TOKEN != '' }}"
          
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # æ¢å¤CIé˜¶æ®µçš„æ„å»ºç¼“å­˜
      - name: æ¢å¤æ„å»ºç¼“å­˜
        uses: actions/cache@v4
        with:
          path: .next
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-
      
      # å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œé‡æ–°æ„å»º
      - name: é‡æ–°æ„å»º (å¦‚éœ€è¦)
        run: |
          if [ ! -d ".next" ]; then
            echo "æ„å»ºç¼“å­˜æœªæ‰¾åˆ°ï¼Œé‡æ–°æ„å»º..."
            npm ci
            npm run build
          else
            echo "ä½¿ç”¨ç¼“å­˜çš„æ„å»ºäº§ç‰©"
          fi
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_OPTIONS: '--max-old-space-size=4096'
      
      # éƒ¨ç½²å‰ç«¯
      - name: éƒ¨ç½²å‰ç«¯åˆ° Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
        
      # éƒ¨ç½²åç«¯
      - name: éƒ¨ç½²åç«¯åˆ° Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-backend-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_BACKEND_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./agent-backend
          scope: ${{ secrets.VERCEL_ORG_ID }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          
      # éƒ¨ç½²åéªŒè¯
      - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
        run: |
          echo "â³ ç­‰å¾…éƒ¨ç½²æœåŠ¡å¯åŠ¨..."
          sleep 90
          
      - name: å‰ç«¯å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥å‰ç«¯éƒ¨ç½²çŠ¶æ€..."
          curl -f "${{ steps.vercel-deploy.outputs.preview-url }}" --max-time 30 || exit 1
          echo "âœ… å‰ç«¯éƒ¨ç½²æˆåŠŸ: ${{ steps.vercel-deploy.outputs.preview-url }}"
          
      - name: åç«¯å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ” æ£€æŸ¥åç«¯éƒ¨ç½²çŠ¶æ€..."
          if [ -n "${{ steps.vercel-backend-deploy.outputs.preview-url }}" ]; then
            BACKEND_URL="${{ steps.vercel-backend-deploy.outputs.preview-url }}"
            echo "åç«¯URL: $BACKEND_URL"
            
            # ç­‰å¾…å®¹å™¨å®Œå…¨å¯åŠ¨
            for i in {1..10}; do
              echo "å°è¯•è¿æ¥åç«¯æœåŠ¡ (ç¬¬ $i æ¬¡)..."
              if curl -f "$BACKEND_URL/health" --max-time 30; then
                echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              else
                echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨..."
                sleep 15
              fi
            done
            
            # æœ€ç»ˆå¥åº·æ£€æŸ¥
            curl -f "$BACKEND_URL/health" --max-time 30 || {
              echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            }
            echo "âœ… åç«¯éƒ¨ç½²æˆåŠŸ: $BACKEND_URL"
          else
            echo "âš ï¸ åç«¯éƒ¨ç½²URLæœªè·å–åˆ°ï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"
          fi

      # ä¿å­˜éƒ¨ç½²ä¿¡æ¯
      - name: ä¿å­˜éƒ¨ç½²ä¿¡æ¯
        run: |
          echo "FRONTEND_URL=${{ steps.vercel-deploy.outputs.preview-url }}" >> $GITHUB_ENV
          echo "BACKEND_URL=${{ steps.vercel-backend-deploy.outputs.preview-url }}" >> $GITHUB_ENV
          echo "DEPLOYMENT_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

  # å¼€å‘ç¯å¢ƒéƒ¨ç½² (developåˆ†æ”¯ï¼ŒCIé€šè¿‡å)
  deploy-development:
    name: å¼€å‘ç¯å¢ƒéƒ¨ç½²
    needs: [run-ci]
    if: needs.run-ci.outputs.ci-passed == 'true' && needs.run-ci.outputs.branch == 'develop'
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # å¼€å‘ç¯å¢ƒéƒ¨ç½² (é¢„è§ˆæ¨¡å¼)
      - name: éƒ¨ç½²å‰ç«¯åˆ° Vercel (é¢„è§ˆ)
        uses: amondnet/vercel-action@v25
        id: vercel-dev-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          working-directory: ./
          
      - name: éƒ¨ç½²åç«¯åˆ° Vercel (å¼€å‘ç¯å¢ƒ)
        uses: amondnet/vercel-action@v25
        id: vercel-backend-dev-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_BACKEND_DEV_PROJECT_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          working-directory: ./agent-backend
          scope: ${{ secrets.VERCEL_ORG_ID }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

      # åŸºç¡€å¥åº·æ£€æŸ¥ (å¼€å‘ç¯å¢ƒè¾ƒå®½æ¾)
      - name: å¼€å‘ç¯å¢ƒå¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ” å¼€å‘ç¯å¢ƒåŸºç¡€æ£€æŸ¥..."
          if [ -n "${{ steps.vercel-dev-deploy.outputs.preview-url }}" ]; then
            curl -f "${{ steps.vercel-dev-deploy.outputs.preview-url }}" --max-time 30 || echo "âš ï¸ å‰ç«¯æ£€æŸ¥å¤±è´¥"
          fi
          echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆ"

  # éƒ¨ç½²çŠ¶æ€æ±‡æ€»
  deployment-summary:
    name: éƒ¨ç½²çŠ¶æ€æ±‡æ€»
    needs: [run-ci, deploy-production, deploy-development]
    if: always() && needs.run-ci.result == 'success' && (needs.deploy-production.result != 'skipped' || needs.deploy-development.result != 'skipped')
    runs-on: ubuntu-latest
    
    steps:
      - name: è®°å½•éƒ¨ç½²ç»“æœ
        run: |
          echo "ğŸ éƒ¨ç½²å®Œæˆæ±‡æ€»"
          echo "=================="
          
          if [[ "${{ needs.deploy-production.result }}" != "skipped" ]]; then
            echo "ğŸ¢ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²: ${{ needs.deploy-production.result }}"
            echo "ğŸ“… åˆ†æ”¯: ${{ github.event.workflow_run.head_branch }}"
            echo "ğŸ’» æäº¤: ${{ github.event.workflow_run.head_sha }}"
            
            if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
              echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
              echo "ğŸŒ å‰ç«¯åœ°å€: https://doudou.vercel.app (é¢„æœŸ)"
              echo "ğŸ”§ åç«¯åœ°å€: https://doudou-backend.vercel.app (é¢„æœŸ)"
            else
              echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
            fi
          fi
          
          if [[ "${{ needs.deploy-development.result }}" != "skipped" ]]; then
            echo "ğŸ§ª å¼€å‘ç¯å¢ƒéƒ¨ç½²: ${{ needs.deploy-development.result }}"
            echo "ğŸ“… åˆ†æ”¯: ${{ github.event.workflow_run.head_branch }}"
            
            if [[ "${{ needs.deploy-development.result }}" == "success" ]]; then
              echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            else
              echo "âŒ å¼€å‘ç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
            fi
          fi
          
          echo "=================="
          echo "ğŸ“Š æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
