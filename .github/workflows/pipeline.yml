name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘ç”¨äºŽæµ‹è¯•
  workflow_dispatch:
    inputs:
      ci_passed:
        description: 'CIæ˜¯å¦é€šè¿‡'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

# æ˜Žç¡®çš„æƒé™é…ç½®
permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # è¿è¡ŒCIæµ‹è¯•
  run-ci:
    name: è¿è¡ŒCIæµ‹è¯•
    runs-on: ubuntu-latest
    outputs:
      ci-passed: ${{ steps.ci-result.outputs.ci-passed }}
      branch: ${{ steps.ci-result.outputs.branch }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci
          npm run preflight
      
      - name: è¿è¡ŒCIæµ‹è¯•
        run: |
          npm run lint
          npm run test:ci
          npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_OPTIONS: '--max-old-space-size=4096'
          
      - name: è®¾ç½®CIç»“æžœ
        id: ci-result
        run: |
          echo "âœ… CIæµ‹è¯•é€šè¿‡ï¼Œå‡†å¤‡éƒ¨ç½²"
          echo "ci-passed=true" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

  # ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½² (mainåˆ†æ”¯ï¼ŒCIé€šè¿‡åŽ)
  deploy-production:
    name: ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²
    needs: [run-ci]
    if: needs.run-ci.outputs.ci-passed == 'true' && needs.run-ci.outputs.branch == 'main'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ” è¯¦ç»†Secretsè¯Šæ–­
        run: |
          echo "=== åŸºæœ¬çŽ¯å¢ƒä¿¡æ¯ ==="
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "ä»“åº“: ${{ github.repository }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository Owner: ${{ github.repository_owner }}"
          echo "=== Secretsè®¿é—®æµ‹è¯• ==="
          echo "VERCEL_TOKEN å­˜åœ¨: ${{ secrets.VERCEL_TOKEN != '' }}"
          echo "VERCEL_ORG_ID å­˜åœ¨: ${{ secrets.VERCEL_ORG_ID != '' }}"
          echo "VERCEL_PROJECT_ID å­˜åœ¨: ${{ secrets.VERCEL_PROJECT_ID != '' }}"
          echo "VERCEL_BACKEND_PROJECT_ID å­˜åœ¨: ${{ secrets.VERCEL_BACKEND_PROJECT_ID != '' }}"
          echo "GITHUB_TOKEN å­˜åœ¨: ${{ secrets.GITHUB_TOKEN != '' }}"
          echo "=== Secretsé•¿åº¦æµ‹è¯• ==="
          echo "VERCEL_TOKEN é•¿åº¦: ${#VERCEL_TOKEN}"
          echo "VERCEL_ORG_ID é•¿åº¦: ${#VERCEL_ORG_ID}"
          echo "VERCEL_PROJECT_ID é•¿åº¦: ${#VERCEL_PROJECT_ID}"
          echo "=== æƒé™å’Œä¸Šä¸‹æ–‡ ==="
          echo "Current user: $(whoami)"
          echo "Environment: $GITHUB_ACTIONS"
          echo "Run ID: $GITHUB_RUN_ID"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # æ¢å¤CIé˜¶æ®µçš„æž„å»ºç¼“å­˜
      - name: æ¢å¤æž„å»ºç¼“å­˜
        uses: actions/cache@v3
        with:
          path: .next
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-
      
      # å¦‚æžœç¼“å­˜æœªå‘½ä¸­ï¼Œé‡æ–°æž„å»º
      - name: é‡æ–°æž„å»º (å¦‚éœ€è¦)
        run: |
          if [ ! -d ".next" ]; then
            echo "æž„å»ºç¼“å­˜æœªæ‰¾åˆ°ï¼Œé‡æ–°æž„å»º..."
            npm ci
            npm run build
          else
            echo "ä½¿ç”¨ç¼“å­˜çš„æž„å»ºäº§ç‰©"
          fi
        env:
          NEXT_TELEMETRY_DISABLED: 1
          NODE_OPTIONS: '--max-old-space-size=4096'
      
      # éƒ¨ç½²å‰ç«¯åˆ° Vercel (ç›´æŽ¥ä½¿ç”¨CLI)
      - name: éƒ¨ç½²å‰ç«¯åˆ° Vercel
        id: vercel-deploy
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²å‰ç«¯åˆ° Vercel..."
          # å®‰è£…æœ€æ–°ç‰ˆVercel CLI
          npm install -g vercel@latest
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          export CI=1
          export VERCEL_ENV=production
          
          # å¼ºåˆ¶éžäº¤äº’å¼éƒ¨ç½²
          echo "y" | vercel --prod --token "${{ secrets.VERCEL_TOKEN }}" --confirm || \
          vercel --prod --token "${{ secrets.VERCEL_TOKEN }}" --force --yes 2>/dev/null || \
          vercel --prod --token "${{ secrets.VERCEL_TOKEN }}" < /dev/null
          
          echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ"
        
      # éƒ¨ç½²åŽç«¯åˆ° Vercel (ç›´æŽ¥ä½¿ç”¨CLI)
      - name: éƒ¨ç½²åŽç«¯åˆ° Vercel
        id: vercel-backend-deploy
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²åŽç«¯åˆ° Vercel..."
          cd agent-backend
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          export CI=1
          export VERCEL_ENV=production
          
          # å¼ºåˆ¶éžäº¤äº’å¼éƒ¨ç½²
          echo "y" | vercel --prod --token "${{ secrets.VERCEL_TOKEN }}" --confirm || \
          vercel --prod --token "${{ secrets.VERCEL_TOKEN }}" --force --yes 2>/dev/null || \
          vercel --prod --token "${{ secrets.VERCEL_TOKEN }}" < /dev/null
          
          echo "âœ… åŽç«¯éƒ¨ç½²å®Œæˆ"
          cd ..
          
      # éƒ¨ç½²åŽéªŒè¯
      - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
        run: |
          echo "â³ ç­‰å¾…éƒ¨ç½²æœåŠ¡å¯åŠ¨..."
          sleep 90
          
      - name: å‰ç«¯å¥åº·æ£€æŸ¥
        run: |
          echo "ðŸ” æ£€æŸ¥å‰ç«¯éƒ¨ç½²çŠ¶æ€..."
          echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆï¼ˆç›´æŽ¥CLIéƒ¨ç½²ï¼Œè·³è¿‡URLæ£€æŸ¥ï¼‰"
          
      - name: åŽç«¯å¥åº·æ£€æŸ¥
        run: |
          echo "ðŸ” æ£€æŸ¥åŽç«¯éƒ¨ç½²çŠ¶æ€..."
          echo "âœ… åŽç«¯éƒ¨ç½²å®Œæˆï¼ˆç›´æŽ¥CLIéƒ¨ç½²ï¼Œè·³è¿‡URLæ£€æŸ¥ï¼‰"

      # ä¿å­˜éƒ¨ç½²ä¿¡æ¯
      - name: ä¿å­˜éƒ¨ç½²ä¿¡æ¯
        run: |
          echo "FRONTEND_URL=ç›´æŽ¥CLIéƒ¨ç½²å®Œæˆ" >> $GITHUB_ENV
          echo "BACKEND_URL=ç›´æŽ¥CLIéƒ¨ç½²å®Œæˆ" >> $GITHUB_ENV
          echo "DEPLOYMENT_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

  # å¼€å‘çŽ¯å¢ƒéƒ¨ç½² (developåˆ†æ”¯ï¼ŒCIé€šè¿‡åŽ)
  deploy-development:
    name: å¼€å‘çŽ¯å¢ƒéƒ¨ç½²
    needs: [run-ci]
    if: needs.run-ci.outputs.ci-passed == 'true' && needs.run-ci.outputs.branch == 'develop'
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      # å¼€å‘çŽ¯å¢ƒéƒ¨ç½² (é¢„è§ˆæ¨¡å¼ï¼Œç›´æŽ¥ä½¿ç”¨CLI)
      - name: éƒ¨ç½²å‰ç«¯åˆ° Vercel (é¢„è§ˆ)
        id: vercel-dev-deploy
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²å‰ç«¯åˆ° Vercel (é¢„è§ˆ)..."
          # å®‰è£…æœ€æ–°ç‰ˆVercel CLI
          npm install -g vercel@latest
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡  
          export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          export CI=1
          export VERCEL_ENV=preview
          
          # å¼ºåˆ¶éžäº¤äº’å¼é¢„è§ˆéƒ¨ç½²
          echo "y" | vercel --token "${{ secrets.VERCEL_TOKEN }}" --confirm || \
          vercel --token "${{ secrets.VERCEL_TOKEN }}" --force --yes 2>/dev/null || \
          vercel --token "${{ secrets.VERCEL_TOKEN }}" < /dev/null
          
          echo "âœ… å‰ç«¯é¢„è§ˆéƒ¨ç½²å®Œæˆ"
          
      - name: éƒ¨ç½²åŽç«¯åˆ° Vercel (å¼€å‘çŽ¯å¢ƒï¼Œç›´æŽ¥ä½¿ç”¨CLI)
        id: vercel-backend-dev-deploy
        run: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²åŽç«¯åˆ° Vercel (é¢„è§ˆ)..."
          cd agent-backend
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          export CI=1
          export VERCEL_ENV=preview
          
          # å¼ºåˆ¶éžäº¤äº’å¼é¢„è§ˆéƒ¨ç½²
          echo "y" | vercel --token "${{ secrets.VERCEL_TOKEN }}" --confirm || \
          vercel --token "${{ secrets.VERCEL_TOKEN }}" --force --yes 2>/dev/null || \
          vercel --token "${{ secrets.VERCEL_TOKEN }}" < /dev/null
          
          echo "âœ… åŽç«¯é¢„è§ˆéƒ¨ç½²å®Œæˆ"
          cd ..

      # åŸºç¡€å¥åº·æ£€æŸ¥ (å¼€å‘çŽ¯å¢ƒè¾ƒå®½æ¾)
      - name: å¼€å‘çŽ¯å¢ƒå¥åº·æ£€æŸ¥
        run: |
          echo "ðŸ” å¼€å‘çŽ¯å¢ƒåŸºç¡€æ£€æŸ¥..."
          echo "âœ… å¼€å‘çŽ¯å¢ƒéƒ¨ç½²å®Œæˆï¼ˆç›´æŽ¥CLIéƒ¨ç½²ï¼Œè·³è¿‡URLæ£€æŸ¥ï¼‰"

  # éƒ¨ç½²çŠ¶æ€æ±‡æ€»
  deployment-summary:
    name: éƒ¨ç½²çŠ¶æ€æ±‡æ€»
    needs: [run-ci, deploy-production, deploy-development]
    if: always() && needs.run-ci.result == 'success' && (needs.deploy-production.result != 'skipped' || needs.deploy-development.result != 'skipped')
    runs-on: ubuntu-latest
    
    steps:
      - name: è®°å½•éƒ¨ç½²ç»“æžœ
        run: |
          echo "ðŸ éƒ¨ç½²å®Œæˆæ±‡æ€»"
          echo "=================="
          
          if [[ "${{ needs.deploy-production.result }}" != "skipped" ]]; then
            echo "ðŸ¢ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²: ${{ needs.deploy-production.result }}"
            echo "ðŸ“… åˆ†æ”¯: ${{ github.event.workflow_run.head_branch }}"
            echo "ðŸ’» æäº¤: ${{ github.event.workflow_run.head_sha }}"
            
            if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
              echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
              echo "ðŸŒ å‰ç«¯åœ°å€: https://doudou.vercel.app (é¢„æœŸ)"
              echo "ðŸ”§ åŽç«¯åœ°å€: https://doudou-backend.vercel.app (é¢„æœŸ)"
            else
              echo "âŒ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
            fi
          fi
          
          if [[ "${{ needs.deploy-development.result }}" != "skipped" ]]; then
            echo "ðŸ§ª å¼€å‘çŽ¯å¢ƒéƒ¨ç½²: ${{ needs.deploy-development.result }}"
            echo "ðŸ“… åˆ†æ”¯: ${{ github.event.workflow_run.head_branch }}"
            
            if [[ "${{ needs.deploy-development.result }}" == "success" ]]; then
              echo "âœ… å¼€å‘çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
            else
              echo "âŒ å¼€å‘çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
            fi
          fi
          
          echo "=================="
          echo "ðŸ“Š æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
